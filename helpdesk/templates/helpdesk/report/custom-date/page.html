{% extends "helpdesk/staff_base.html" %}
{% load i18n humanize %}
{% load static from staticfiles %}
{% block helpdesk_title %}{% trans "Report::Custom Date" %}{% endblock %}
{% load pagination_tags %}
{% load helpdesk_util_tags %}

{% block extra_css %}
<link href="{% static 'helpdesk/css/chosen.min.css' %}" rel="stylesheet">
<link href="{% static 'helpdesk/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block breadcrumb_items %}
<li>Custom Date Report</li>
{% endblock %}

{% block content %}
<h2 class="row page-title ticket-list-title">
    <span>Custom Date Report</span> <span class="custom-date-range-title label subtitle">{{date_range.0}} ({{date_range.1.0}} - {{date_range.1.1}})</span>
    <span class="pull-right">
        <span class="dropdown">
            <button class="btn btn-info dropdown-toggle" type="button" data-toggle="dropdown"><span class="fa fa-download"></span><span class="hidden-xs"> Export
            </span> <span class="caret"></span></button>
            <ul class="dropdown-menu dropdown-menu-right">
                <li><a href="javascript:" id="pdf-export" title="Export to PDF"><span class="fa fa-fw fa-file-pdf-o"></span> PDF</a></li>
                <li><a href="javascript:" id="csv-export" title="Export to CSV"><span class="fa fa-fw fa-file-excel-o"></span> CSV</a></li>
            </ul>
        </span>
    </span>
</h2>

<div class="panel panel-default" id="tickets-list" style="display: none;">
    <div class="panel-heading">
        <button type="button" class="btn btn-xs btn-link collapse-link" data-toggle="collapse" data-target="#tickets-filters"><span class="subtitle">Filters</span></button>

        <div class="pull-right">
            <button class="btn btn-danger btn-xs clear-filter" title="Clear All Filters"><span class="fa fa-close"></span> Clear Filters</button>
        </div>
    </div>
    <div class="panel-body">
        <div id="tickets-filters" class="filters collapse in">
            <form id="filterForm" class="form-inline" role="form" action="">
                {% if request.GET.order_by %}
                <input type="hidden" name="order_by" value="{{ request.GET.order_by }}">
                {% endif %}
                <input type="hidden" name="page_size" value="{{ request.GET.page_size }}">
                {{tickets.form.date_range.as_hidden}}
                <div class="form-group col-xs-6 col-md-3 col-sm-3 form-group-packed">
                    <label class="label-xs hidden-lg hidden-md hidden-sm">From Date</label>
                    {{tickets.form.created_min}}
                </div>
                <div class="form-group col-xs-6 col-md-3 col-sm-3 form-group-packed">
                    <label class="label-xs hidden-lg hidden-md hidden-sm">To Date</label>
                    {{tickets.form.created_max}}
                </div>
                <div class="form-group col-sm-6 form-group-packed">
                    <span class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                            <span class="fa fa-calendar"></span> {{date_range.0}} ({{date_range.1.0}} - {{date_range.1.1}})
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                        {% for r, d in date_range_choices %}
                            <li><a href="?{% make_request_param_for_link drop_fields='created_min,created_max' date_range=r%}">{{d}}</a></li>
                        {% endfor %}
                        </ul>
                    </span>
                </div>
            </form>
        </div>
    </div>

    {% with tickets.qs as qs %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-advance sortable">
            <tr>
                <th>{% sorting_link 'ID#' 'id' %}</th>
                <th>{% sorting_link 'Title' 'title' %}</th>
                <th>{% sorting_link 'Location' 'queue' %}</th>
                <th>{% sorting_link 'Owner' 'assigned_to' %}</th>
                <th>{% sorting_link 'Priority' 'priority' %}</th>
                <th>{% sorting_link 'Repair Reported' 'created' %}</th>
                <th>{% sorting_link 'Repair Completed' 'closed_at_null' %}</th>
                <th>{% sorting_link 'Time Log' 'time_tracks' %}</th>
                <th>{% sorting_link 'Amount' 'money_tracks' %}</th>
            </tr>
            {% autopaginate qs page_size %}
            {% for ticket in qs %}
            <tr data-id="{{ ticket.id }}">
                <td title="{{ticket.ticket}}"><a href='{{ ticket.get_absolute_url }}'>{{ ticket.id }}</a></td>
                <td><a href='{{ ticket.get_absolute_url }}'>{{ ticket.title }}</a></td>
                <td>{{ ticket.queue }}</td>
                <td title="{{ ticket.get_assigned_to }}">{{ ticket.assigned_to|default:'-' }}</td>
                <td>{{ ticket.priority|ticket_priority_label_class }}</td>
                <td>{{ ticket.created|date:'m/d/Y' }}</td>
                <td>{{ ticket.closed_at|date:'m/d/Y'|default:'-' }}</td>
                <td title="{{ ticket.time_tracks|humanize_duration|default:'NO TIME' }}">
                    {% with total_time_tracked=ticket.total_time_tracked %}
                    {% if total_time_tracked %}
                        {{ total_time_tracked|seconds_to_time:'hour' }}hr over {{ticket.records_time_tracked}} D
                    {% else %}
                        -
                    {% endif %}
                    {% endwith %}
                </td>
                <td>{{ ticket.money_tracks|currency }}</td>
            </tr>
            {% empty %}
            <tr>
                <td class="text-center text-muted" colspan="9"><em>[NO RECORD!]</em></td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <div class="panel-footer">
        {% paginate %}
        <div class="pull-right mar-top10">
            {% pagination_info %}
            {% page_size_combo %}
        </div>
    </div>
    {% endwith %}

</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'helpdesk/js/chosen.jquery.min.js' %}"></script>
<script src="{% static 'helpdesk/js/moment.min.js' %}"></script>
<script src="{% static 'helpdesk/js/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{% static 'helpdesk/js/util.js' %}"></script>
<script src="{% static 'helpdesk/js/jspdf.min.js' %}"></script>
<script src="{% static 'helpdesk/js/jspdf.plugin.autotable.js' %}"></script>
<script src="{% static 'helpdesk/js/FileSaver.min.js' %}"></script>

<script type="text/javascript" charset="utf-8">
    var urlPath = window.location.pathname,
        urlParams = window.location.search,
        exportColumns = [
            {title: 'ID', dataKey: 'id'},
            {title: 'Title', dataKey: 'title'},
            {title: 'Location', dataKey: 'queue'},
            {title: 'Owner', dataKey: 'assigned_to'},
            {title: 'Priority', dataKey: 'priority'},
            {title: 'Repair Reported', dataKey: 'created'},
            {title: 'Repair Completed', dataKey: 'closed_at'},
            {title: 'Time Log', dataKey: 'time_tracks'},
            {title: 'Amount', dataKey: 'money_tracks'}
        ];

    function prepareRecordsForExport(records) {
        return records.map(function (r) {
            r.money_tracks = '${0}'.format(r.money_tracks);
            r.closed_at = r.closed_at || '-';
            r.assigned_to = r.assigned_to || '-';
            r.time_tracks = r.time_tracks || '-';
            return r;
        });

    }

    $(document).ready(function () {
        $('#csv-export').on('click', function() {
            var params = new URLSearchParams(urlParams);
            var url = '{0}?{1}'.format(urlPath, params.toString());
            $.get(url).done(function(records) {
                exportToCSV(exportColumns, prepareRecordsForExport(records), {
                    fileName: 'tickets-report.csv', nameField: 'dataKey'
                });
            }).fail(function(response) {
                showAlert('Failed to export to csv!', 'danger');
            })
        });
        $('#pdf-export').on('click', function() {
            var params = new URLSearchParams(urlParams);
            var url = '{0}?{1}'.format(urlPath, params.toString());
            $.get(url).done(function(records) {
                exportToPDF(exportColumns, prepareRecordsForExport(records), {
                    fileName: 'tickets-report.pdf',
                    jspdfDoc: new jsPDF('p', 'pt', 'a3'),
                    jspdfOptions: {
                        columnStyles: {
                            id: {columnWidth: 35},
                            queue: {columnWidth: 110},
                            priority: {columnWidth: 50},
                            status: {columnWidth: 60},
                            time_open: {columnWidth: 55},
                            time_tracks: {columnWidth: 55},
                            money_tracks: {columnWidth: 45},
                            created: {columnWidth: 70},
                            closed_at: {columnWidth: 70},
                            assigned_to: {columnWidth: 80}
                        }
                    }
                });
            }).fail(function(response) {
                showAlert('Failed to export to pdf!', 'danger');
            })
        });
        $('[data-toggle="tooltip"]').tooltip();
        $('.datepicker-widget').datetimepicker({
            format: 'YYYY-MM-DD',
            showTodayButton: true,
            useCurrent: false,
            showClear: true
        });
        $('#filterForm [name][type!=hidden]').on('change dp.change', function () {
            var form = $(this).parents('form'),
                fieldName = $(this).attr('name');
            if (fieldName === 'created_max' || fieldName === 'created_min') {
                form.find('[name=date_range]').val('');
            }
            form.submit();
        });
        $('.page-size').chosen({disable_search: true, allow_single_deselect: true}).on('change', function () {
            $('input[name=page_size]').val($(this).val());
            $('#filterForm').submit();
        });
        $('.clear-filter').click(function () {
            var form = $('#filterForm');
            $('[name]', form).val('').attr('disabled', true).trigger("chosen:updated");
            form.submit();
        });
        $('#tickets-list').show();

    });
</script>

{% endblock extra_js %}
