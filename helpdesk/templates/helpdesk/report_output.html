{% extends "helpdesk/staff_base.html" %}{% load i18n %}
{% load static from staticfiles %}
{% load saved_queries %}

{% block extra_css%}
<!-- Morris Charts CSS -->
{% if helpdesk_settings.HELPDESK_USE_CDN %}
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
{% else %}
<link href="{% static 'helpdesk/vendor/morrisjs/morris.css' %}" rel="stylesheet">
{% endif %}
<link href="{% static 'helpdesk/css/chosen.min.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block breadcrumb_items %}
<li><a href="{% url 'helpdesk:report_index' %}">{% trans "Reports &amp; Statistics" %}</a></li>
<li>{{title}}</li>
{% endblock %}

{% block helpdesk_title %}{% trans "Reports &amp; Statistics" %}{% endblock %}

{% block content %}
<h2 class="page-title">{% trans "Reports &amp; Statistics" %}<span class="label subtitle">{{title}}</span></h2>

<div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            {% trans 'Saved Queries' %}
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
{% if user_saved_queries %}
    <p>{% trans "You can run this query on filtered data by using one of your saved queries." %}</p>
    <form method="GET" class="form-inline" id="reportSavedQueryForm">
        <label for="id_saved_query">{% trans "Select Query:" %}</label>
        <select name="saved_query" id="id_saved_query" class="form-control" data-placeholder="No Query">
            <option value></option>
            {% for q in user_saved_queries %}
            <option value="{{ q.id }}"{% ifequal saved_query q %} selected{% endifequal %}>{{ q.title }}</option>
            {% endfor %}
        </select>
    </form>
{% else %}
    <p>{% trans "Want to filter this report to just show a subset of data? Go to the Ticket List, filter your query, and save your query." %}</p>
{% endif %}

                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            {{ title }}
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>{% for h in headings %}
                                            <th>{% if forloop.first %}{{ h|title }}{% else %}{{ h }}{% endif %}</th>{% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for d in data %}
                                        <tr class='row_{% cycle 'odd' 'even' %}'>
                                            {% for f in d %}
                                            <td class='report'>
                                                {% if forloop.counter == 1 %}
                                                {{ f }}
                                                {% else %}
                                                {{ f|floatformat:"-2" }}
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.table-responsive -->
                            <div class="flot-chart">
                                <div class="flot-chart-content" id="chart-content"></div>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
            </div>

{% endblock %}

{% block extra_js %}

    <!-- Flot Charts JavaScript -->
    <script src="/static/helpdesk/vendor/flot/excanvas.min.js"></script>
    <script src="/static/helpdesk/vendor/flot/jquery.flot.js"></script>
    <script src="/static/helpdesk/vendor/flot/jquery.flot.categories.js"></script>
    <script src="/static/helpdesk/vendor/flot/jquery.flot.pie.js"></script>
    <script src="/static/helpdesk/vendor/flot/jquery.flot.resize.js"></script>
    <script src="/static/helpdesk/vendor/flot/jquery.flot.time.js"></script>
    <script src="/static/helpdesk/vendor/flot-tooltip/jquery.flot.tooltip.min.js"></script>

    <!-- Morris Charts JavaScript -->
    {% if helpdesk_settings.HELPDESK_USE_CDN %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
    {% else %}
    <script src="{% static 'helpdesk/vendor/raphael/raphael.min.js' %}"></script>
    <script src="{% static 'helpdesk/vendor/morrisjs/morris.min.js' %}"></script>
    {% endif %}
    <script src="{% static 'helpdesk/js/chosen.jquery.min.js' %}"></script>

    <script type='text/javascript'>
    $(document).ready(function () {
        $('#id_saved_query').chosen({allow_single_deselect: true}).on('change', function () {
            $('#reportSavedQueryForm').submit();
        });
        var chartType = '{{charttype}}';
        if (chartType === "bar") {
            Morris.Bar({
                element: 'chart-content',
                data: {% autoescape on %}{{ morrisjs_data|safe }}{% endautoescape %},
                xkey: 'x',
                ykeys: [{% for d in data %}{{ forloop.counter0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                labels: [{% for n in series_names %}"{{ n }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
            });
         }

        if (chartType === "date") {
            Morris.Line({
              element: 'chart-content',
              data: {% autoescape on %}{{ morrisjs_data|safe }}{% endautoescape %},
              xkey: 'x',
              ykeys: [{% for d in data %}{{ forloop.counter0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
              labels: [{% for n in series_names %}"{{ n }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
              xLabels: "month"
            });
        }

    });
    </script>
{% endblock extra_js %}
